<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mental Health Dashboard | Sarah Chen</title>
    
    <!--
    Chosen Palette: Calm Clarity
    Application Structure Plan: A dashboard layout is used for its suitability in presenting a multi-faceted report. The structure is a responsive two-column grid. The left column contains contextual, semi-static information (Patient Summary, Medications), allowing users to get a quick overview. The right, more prominent column is dedicated to the primary interactive element: the trends chart. This prioritizes data exploration. The user flow is top-down: from the high-level overall score, to the summary, and then to the detailed, interactive chart. Time-range filter buttons (3M, 1Y, All) were added to the chart to provide direct control over the data view, enhancing usability by allowing users to focus on different periods of the patient's history.
    Visualization & Content Choices:
    - Overall Score: Inform -> Dynamic Stat -> HTML/CSS -> A large, visually distinct number to provide an immediate, high-level metric of patient wellness.
    - Patient Summary: Inform -> Contextual Text Blocks -> HTML/CSS -> Structured text to give a quick, qualitative overview of the patient's situation and goals.
    - Medications List: Organize/Inform -> Interactive Table -> HTML Table -> A clear, structured list for easy reference of the patient's treatment regimen.
    - Progress Trends: Change/Compare/Relationships -> Interactive Line Chart -> Chart.js (Canvas) -> Chosen for its ability to show trends over time. Interaction: Hover tooltips with event details provide deeper, point-in-time context. Clickable filters dynamically update the chart (now including a 3-month weekly view), allowing users to compare different periods. This is the most effective way to visualize the relationship between events and mental state.
    CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
    -->

    <script src="https://cdn.tailwindcss.com/3.4.0/tailwind.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Note: Babel is only needed for JSX transformation. Consider removing if not using JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="../config.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .chart-container {
            position: relative;
            height: 450px;
            width: 100%;
            max-width: 1000px;
            margin-left: auto;
            margin-right: auto;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .tooltip {
            opacity: 0;
            pointer-events: none;
            position: absolute;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            transition: opacity 0.2s ease;
            width: 280px;
            transform: translate(-50%, -115%);
        }
    </style>
</head>
<body class="text-slate-800">

    <main class="p-4 sm:p-6 lg:p-8 max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-900 tracking-tight">Mental Health Dashboard</h1>
            <p class="mt-2 text-lg text-slate-600">Patient: <span class="font-semibold" id="patientName"></span></p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 lg:gap-8">

            <div class="lg:col-span-1 space-y-8">
                <section id="overallScoreSection" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-sm font-semibold text-slate-500 uppercase tracking-wider">Overall Mental Fitness</h2>
                    <div id="overallScore" class="text-7xl font-bold text-indigo-600 mt-2"></div>
                     <p class="text-sm text-slate-500 mt-1">This score provides a holistic view of the patient's current mental well-being, calculated from recent mood, productivity, and anxiety levels. It serves as a quick indicator of their overall state.</p>
                </section>
                
                <section id="patientSummarySection" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Patient Summary</h2>
                    <div id="patientSummary" class="space-y-3 text-slate-700"></div>
                     <p class="text-sm text-slate-500 mt-4 bg-slate-50 p-3 rounded-lg border border-slate-200">This section provides essential context about the patient, including their diagnosis, care team, and therapeutic goals. The narrative summary offers qualitative insights from the latest clinical observations.</p>
                </section>

                <section id="medicationsSection" class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h2 class="text-xl font-bold text-slate-800 mb-4">Current Medications</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-slate-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Medication</th>
                                    <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Dosage</th>
                                    <th class="px-4 py-2 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="medicationsTable" class="divide-y divide-slate-200">
                            </tbody>
                        </table>
                    </div>
                     <p class="text-sm text-slate-500 mt-4">A concise list of all medications the patient is currently prescribed. This helps in correlating treatment regimens with the observed trends in the progress chart.</p>
                </section>
            </div>

            <div class="lg:col-span-2 mt-8 lg:mt-0">
                <section id="progressChartSection" class="bg-white p-4 sm:p-6 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex flex-wrap justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">Progress Trends</h2>
                             <p class="text-sm text-slate-500 max-w-lg">This chart visualizes the patient's self-reported levels for key mental health indicators over time. Hover over any point on the lines to see specific values and any significant events that occurred on that date, such as medication changes. Use the filters to adjust the time range.</p>
                        </div>
                        <div id="chart-filters" class="flex items-center gap-2 mt-3 sm:mt-0">
                            <button data-range="3m" class="bg-indigo-600 text-white px-3 py-1.5 text-sm font-semibold rounded-md shadow-sm">3M</button>
                            <button data-range="1y" class="bg-slate-200 text-slate-700 px-3 py-1.5 text-sm font-semibold rounded-md shadow-sm">1Y</button>
                            <button data-range="all" class="bg-slate-200 text-slate-700 px-3 py-1.5 text-sm font-semibold rounded-md shadow-sm">All</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="mentalHealthChart"></canvas>
                        <div id="chart-tooltip" class="tooltip"></div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // Load configuration first
            await window.AppConfig.loadConfig();
            const patientData = {
                name: 'Sarah Chen',
                overallFitnessScore: 78,
                summary: {
                    diagnosis: 'Major Depressive Disorder, Generalized Anxiety Disorder',
                    therapist: 'Dr. Emily White',
                    lastSession: 'June 20, 2025',
                    upcomingAppointment: 'July 5, 2025 - 10:00 AM',
                    narrativeSummary: 'Patient reports improved mood after recent medication adjustment. Still experiencing some anxiety in social settings but coping mechanisms are helping.'
                },
                medications: [
                    { name: 'Sertraline', dosage: '50mg', status: 'Active' },
                    { name: 'Buspirone', dosage: '10mg', status: 'Active' },
                    { name: 'Melatonin', dosage: '3mg', status: 'Active' },
                ],
                history: [
                    { date: '2024-01-01', depression: 8, anxiety: 7, happiness: 3, productivity: 4 },
                    { date: '2024-02-01', depression: 7.5, anxiety: 6.8, happiness: 3.5, productivity: 4.2 },
                    { date: '2024-03-01', depression: 7, anxiety: 6.5, happiness: 4, productivity: 4.5 },
                    { date: '2024-04-01', depression: 6.5, anxiety: 6, happiness: 5, productivity: 5, event: { type: 'Medication Start', details: 'Started Sertraline 25mg' } },
                    { date: '2024-05-01', depression: 6, anxiety: 5.5, happiness: 5.5, productivity: 5.5 },
                    { date: '2024-06-01', depression: 5.5, anxiety: 5, happiness: 6, productivity: 6 },
                    { date: '2024-07-01', depression: 5, anxiety: 4.8, happiness: 6.5, productivity: 6.2 },
                    { date: '2024-08-01', depression: 4.8, anxiety: 4.5, happiness: 6.8, productivity: 6.5, event: { type: 'Dose Change', details: 'Sertraline to 50mg' } },
                    { date: '2024-09-01', depression: 4.5, anxiety: 4.2, happiness: 7, productivity: 6.8 },
                    { date: '2024-10-01', depression: 4.2, anxiety: 4, happiness: 7.2, productivity: 7 },
                    { date: '2024-11-01', depression: 4, anxiety: 3.8, happiness: 7.5, productivity: 7.2 },
                    { date: '2024-12-01', depression: 3.8, anxiety: 3.5, happiness: 7.8, productivity: 7.5 },
                    { date: '2025-01-01', depression: 3.5, anxiety: 3.2, happiness: 8, productivity: 7.8 },
                    { date: '2025-02-01', depression: 3.2, anxiety: 3, happiness: 8.2, productivity: 8 },
                    { date: '2025-03-01', depression: 3, anxiety: 2.8, happiness: 8.5, productivity: 8.2, event: { type: 'Therapy Start', details: 'Started CBT sessions' } },
                    { date: '2025-04-01', depression: 2.8, anxiety: 2.5, happiness: 8.8, productivity: 8.5 },
                    { date: '2025-05-10', depression: 2.5, anxiety: 2.2, happiness: 9, productivity: 8.8, event: { type: 'Medication Add', details: 'Added Buspirone 10mg' } },
                    { date: '2025-06-01', depression: 2.2, anxiety: 2, happiness: 9.2, productivity: 9 },
                    { date: '2025-06-23', depression: 2, anxiety: 1.8, happiness: 9.5, productivity: 9.2 },
                ]
            };

            function populateUI() {
                document.getElementById('patientName').textContent = patientData.name;
                document.getElementById('overallScore').textContent = patientData.overallFitnessScore;
                
                const summaryContainer = document.getElementById('patientSummary');
                summaryContainer.innerHTML = `
                    <p><span class="font-semibold text-slate-800">Diagnosis:</span> ${patientData.summary.diagnosis}</p>
                    <p><span class="font-semibold text-slate-800">Therapist:</span> ${patientData.summary.therapist}</p>
                    <p><span class="font-semibold text-slate-800">Last Session:</span> ${patientData.summary.lastSession}</p>
                    <p><span class="font-semibold text-slate-800">Upcoming:</span> ${patientData.summary.upcomingAppointment}</p>
                    <p class="pt-2"><span class="font-semibold text-slate-800">Narrative:</span> <em class="text-slate-600">"${patientData.summary.narrativeSummary}"</em></p>
                `;

                const medsTable = document.getElementById('medicationsTable');
                medsTable.innerHTML = patientData.medications.map(med => `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-3 text-sm font-medium text-slate-900">${med.name}</td>
                        <td class="px-4 py-3 text-sm text-slate-600">${med.dosage}</td>
                        <td class="px-4 py-3 text-sm">
                            <span class="px-2 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                ${med.status}
                            </span>
                        </td>
                    </tr>
                `).join('');
            }

            let mentalHealthChart = null;
            const ctx = document.getElementById('mentalHealthChart').getContext('2d');
            
            const datasets = [
                {
                    label: 'Depression',
                    data: [],
                    borderColor: '#ef4444',
                    backgroundColor: '#ef4444',
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 7,
                },
                {
                    label: 'Anxiety',
                    data: [],
                    borderColor: '#f97316',
                    backgroundColor: '#f97316',
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 7,
                },
                {
                    label: 'Happiness',
                    data: [],
                    borderColor: '#22c55e',
                    backgroundColor: '#22c55e',
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 7,
                },
                {
                    label: 'Productivity',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: '#3b82f6',
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 7,
                }
            ];

            function generateWeeklyData(startDate, endDate) {
                const weeklyData = [];
                let currentDate = new Date(startDate);
                currentDate.setDate(currentDate.getDate() - (currentDate.getDay() + 6) % 7);

                const lastHistoryDate = new Date(patientData.history[patientData.history.length - 1].date);
                
                while (currentDate <= endDate) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    let dataPoint = patientData.history.find(h => h.date === dateStr);

                    if (!dataPoint) {
                        // Interpolate data for missing weekly points based on nearest monthly points
                        const previousMonthlyPoint = patientData.history.reduce((prev, curr) => {
                            const currDate = new Date(curr.date);
                            return currDate <= currentDate && currDate > new Date(prev.date) ? curr : prev;
                        }, patientData.history[0]);

                        const nextMonthlyPoint = patientData.history.find(h => new Date(h.date) >= currentDate);

                        if (previousMonthlyPoint && nextMonthlyPoint) {
                            const prevDate = new Date(previousMonthlyPoint.date);
                            const nextDate = new Date(nextMonthlyPoint.date);
                            const ratio = (currentDate - prevDate) / (nextDate - prevDate);

                            dataPoint = {
                                date: dateStr,
                                depression: previousMonthlyPoint.depression + ratio * (nextMonthlyPoint.depression - previousMonthlyPoint.depression),
                                anxiety: previousMonthlyPoint.anxiety + ratio * (nextMonthlyPoint.anxiety - previousMonthlyPoint.anxiety),
                                happiness: previousMonthlyPoint.happiness + ratio * (nextMonthlyPoint.happiness - previousMonthlyPoint.happiness),
                                productivity: previousMonthlyPoint.productivity + ratio * (nextMonthlyPoint.productivity - previousMonthlyPoint.productivity),
                            };
                        } else if (previousMonthlyPoint) {
                             dataPoint = {
                                date: dateStr,
                                depression: previousMonthlyPoint.depression,
                                anxiety: previousMonthlyPoint.anxiety,
                                happiness: previousMonthlyPoint.happiness,
                                productivity: previousMonthlyPoint.productivity,
                            };
                        } else if (nextMonthlyPoint) {
                            dataPoint = {
                                date: dateStr,
                                depression: nextMonthlyPoint.depression,
                                anxiety: nextMonthlyPoint.anxiety,
                                happiness: nextMonthlyPoint.happiness,
                                productivity: nextMonthlyPoint.productivity,
                            };
                        } else {
                            dataPoint = { date: dateStr, depression: 0, anxiety: 0, happiness: 0, productivity: 0 }; // Fallback
                        }
                    }
                    weeklyData.push(dataPoint);
                    currentDate.setDate(currentDate.getDate() + 7);
                }

                // Add events back to the generated weekly data if they fall within the range
                const historyWithEvents = patientData.history.filter(d => d.event && new Date(d.date) >= startDate && new Date(d.date) <= endDate);
                historyWithEvents.forEach(eventData => {
                    const existingPointIndex = weeklyData.findIndex(d => d.date === eventData.date);
                    if (existingPointIndex > -1) {
                        weeklyData[existingPointIndex].event = eventData.event;
                    } else {
                        // If an event falls on a day that isn't a generated weekly point, add it.
                        // This might create non-weekly points, but ensures events are shown.
                        weeklyData.push(eventData);
                    }
                });

                weeklyData.sort((a, b) => new Date(a.date) - new Date(b.date));
                return weeklyData;
            }
            
            function createOrUpdateChart(filteredData, unit = 'month') {
                if (mentalHealthChart) {
                    mentalHealthChart.destroy();
                }

                datasets.forEach(ds => {
                    ds.data = filteredData.map(d => ({ x: new Date(d.date), y: d[ds.label.toLowerCase()] }))
                });

                mentalHealthChart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: unit,
                                    tooltipFormat: unit === 'week' ? 'MMM dd, yyyy' : 'MMM yyyy',
                                    displayFormats: {
                                        week: 'MMM dd',
                                        month: 'MMM yyyy',
                                        year: 'yyyy'
                                    }
                                },
                                grid: { display: false },
                                ticks: {
                                    font: { size: 10 }
                                }
                            },
                            y: {
                                beginAtZero: true,
                                max: 10,
                                grid: {
                                    color: '#e2e8f0',
                                    drawBorder: false,
                                },
                                ticks: {
                                    stepSize: 2,
                                    font: { size: 10 }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'bottom',
                                align: 'start',
                                labels: {
                                    boxWidth: 12,
                                    padding: 20,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                enabled: false,
                                external: function(context) {
                                    const tooltipEl = document.getElementById('chart-tooltip');
                                    const tooltipModel = context.tooltip;
                                    if (tooltipModel.opacity === 0) {
                                        tooltipEl.style.opacity = 0;
                                        return;
                                    }
                                    const date = new Date(tooltipModel.dataPoints[0].parsed.x);
                                    const pointData = filteredData.find(d => new Date(d.date).getTime() === date.getTime());

                                    let innerHtml = `<div class="font-bold text-slate-800 mb-2">${date.toLocaleDateString(undefined, {month: 'long', day: 'numeric', year: 'numeric'})}</div>`;
                                    tooltipModel.body.forEach((body, i) => {
                                        const colors = tooltipModel.labelColors[i];
                                        innerHtml += `
                                            <div class="flex items-center text-sm mb-1">
                                                <span class="w-3 h-3 rounded-full mr-2" style="background-color: ${colors.backgroundColor}"></span>
                                                <span class="text-slate-600">${body.lines[0]}</span>
                                            </div>
                                        `;
                                    });

                                    if (pointData && pointData.event) {
                                        innerHtml += `
                                            <div class="mt-3 pt-3 border-t border-slate-200">
                                                <p class="font-semibold text-sm text-indigo-600">${pointData.event.type}</p>
                                                <p class="text-xs text-slate-500">${pointData.event.details}</p>
                                            </div>
                                        `;
                                    }
                                    
                                    tooltipEl.innerHTML = innerHtml;

                                    const position = context.chart.canvas.getBoundingClientRect();
                                    tooltipEl.style.opacity = 1;
                                    tooltipEl.style.left = position.left + window.pageXOffset + tooltipModel.caretX + 'px';
                                    tooltipEl.style.top = position.top + window.pageYOffset + tooltipModel.caretY + 'px';
                                },
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index',
                        },
                        elements: {
                            point: {
                                radius: (ctx) => {
                                    const date = new Date(ctx.parsed.x);
                                    const dataPoint = filteredData.find(d => new Date(d.date).getTime() === date.getTime());
                                    return dataPoint && dataPoint.event ? 8 : 4;
                                },
                                hoverRadius: (ctx) => {
                                    const date = new Date(ctx.parsed.x);
                                    const dataPoint = filteredData.find(d => new Date(d.date).getTime() === date.getTime());
                                    return dataPoint && dataPoint.event ? 11 : 7;
                                },
                                backgroundColor: (ctx) => {
                                    const date = new Date(ctx.parsed.x);
                                    const dataPoint = filteredData.find(d => new Date(d.date).getTime() === date.getTime());
                                    return dataPoint && dataPoint.event ? '#4f46e5' : ctx.dataset.backgroundColor;
                                }
                            }
                        }
                    }
                });
            }

            const filterButtons = document.querySelectorAll('#chart-filters button');
            filterButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    filterButtons.forEach(btn => {
                        btn.classList.remove('bg-indigo-600', 'text-white');
                        btn.classList.add('bg-slate-200', 'text-slate-700');
                    });
                    e.target.classList.add('bg-indigo-600', 'text-white');
                    e.target.classList.remove('bg-slate-200', 'text-slate-700');

                    const range = e.target.getAttribute('data-range');
                    let displayData = [];
                    let timeUnit = 'month';

                    if (range === '3m') {
                        const endDate = new Date(patientData.history[patientData.history.length - 1].date);
                        const startDate = new Date(endDate);
                        startDate.setMonth(startDate.getMonth() - 3);
                        displayData = generateWeeklyData(startDate, endDate);
                        timeUnit = 'week';
                    } else if (range === '1y') {
                        const endDate = new Date(patientData.history[patientData.history.length - 1].date);
                        const startDate = new Date(endDate);
                        startDate.setFullYear(startDate.getFullYear() - 1);
                        displayData = patientData.history.filter(d => new Date(d.date) >= startDate);
                        timeUnit = 'month';
                    } else { // 'all'
                        displayData = patientData.history;
                        timeUnit = 'month'; // Or 'year' depending on the overall range
                    }
                    createOrUpdateChart(displayData, timeUnit);
                });
            });

            populateUI();
            document.querySelector('#chart-filters button[data-range="3m"]').click();
        });
    </script>

    <!-- React code placeholder -->
    <script type="text/babel">
    // Place your compiled React code here
    </script>

</body>
</html>
